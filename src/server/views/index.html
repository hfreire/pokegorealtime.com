<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Pokémon Go Realtime</title>

    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="Discover Pokémons nearby in realtime">

    <meta name="viewport" content="initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,shrink-to-fit=no">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Pokémon Go Realtime">
    <meta name="application-name" content="Pokémon Go Realtime">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="google" content="notranslate">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/css/materialize.min.css">
    <link rel="shortcut icon" href="static/images/favicon.ico">
    <link rel="icon" sizes="192x192" href="static/images/touch-icon-192x192.png">
    <link rel="apple-touch-icon" href="static/images/apple-touch-icon.png">

    <style>
        html {
            height: 100%
        }

        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #map {
            height: 100%;
            width: 100%;
        }
    </style>

</head>

<body>

<div id="map"></div>

<script type="text/javascript"
        src="//maps.google.com/maps/api/js?key=AIzaSyBjTwYHBjB3nQaK4f6xqQsm0OQwNEY5fVM"></script>
<script type="text/javascript"
        src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script type="text/javascript"
        src="//cdnjs.cloudflare.com/ajax/libs/js-marker-clusterer/1.0.0/markerclusterer_compiled.js"></script>
<script type="text/javascript"
        src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment.min.js"></script>
<script>
    $(document).ready(function () {

        function addYourLocationButton (map) {
            var controlDiv = document.createElement('div');

            var firstChild = document.createElement('button');
            firstChild.style.backgroundColor = '#fff';
            firstChild.style.border = 'none';
            firstChild.style.outline = 'none';
            firstChild.style.width = '28px';
            firstChild.style.height = '28px';
            firstChild.style.borderRadius = '2px';
            firstChild.style.boxShadow = '0 1px 4px rgba(0,0,0,0.3)';
            firstChild.style.cursor = 'pointer';
            firstChild.style.marginRight = '10px';
            firstChild.style.padding = '0';
            firstChild.title = 'Your Location';
            controlDiv.appendChild(firstChild);

            var secondChild = document.createElement('div');
            secondChild.style.margin = '5px';
            secondChild.style.width = '18px';
            secondChild.style.height = '18px';
            secondChild.style.backgroundImage = 'url(https://maps.gstatic.com/tactile/mylocation/mylocation-sprite-2x.png)';
            secondChild.style.backgroundSize = '180px 18px';
            secondChild.style.backgroundPosition = '0 0';
            secondChild.style.backgroundRepeat = 'no-repeat';
            firstChild.appendChild(secondChild);

            google.maps.event.addListener(map, 'center_changed', function () {
                secondChild.style[ 'background-position' ] = '0 0';
            });

            firstChild.addEventListener('click', function () {
                var imgX = '0',
                        animationInterval = setInterval(function () {
                            imgX = imgX === '-18' ? '0' : '-18';
                            secondChild.style[ 'background-position' ] = imgX + 'px 0';
                        }, 500);

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function (position) {
                        var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                        map.setCenter(latlng);
                        clearInterval(animationInterval);
                        secondChild.style[ 'background-position' ] = '-144px 0';
                    });
                } else {
                    clearInterval(animationInterval);
                    secondChild.style[ 'background-position' ] = '0 0';
                }
            });

            controlDiv.index = 1;
            map.controls[ google.maps.ControlPosition.RIGHT_BOTTOM ].push(controlDiv);
        }

        function isMobile () {
            return isMobileiPhone() || isMobileAndroid();
        }

        function isMobileiPhone() {
            return navigator.userAgent.indexOf('iPhone') != -1;
        }

        function isMobileAndroid() {
            return navigator.userAgent.indexOf('Android') != -1;
        }

        var map = new google.maps.Map(document.getElementById("map"), {
            zoom: 15,
            minZoom: 13,
            center: new google.maps.LatLng(59.328221, 18.070394),
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            mapTypeControl: false,
            zoomControl: !isMobile(),
            panControl: false,
            scaleControl: false,
            navigationControl: false,
            draggable: true,
            scrollwheel: false,
            streetViewControl: false,
            styles: [
                {
                    "featureType": "all",
                    "elementType": "labels",
                    "stylers": [ { "visibility": "off" } ]
                },
                {
                    "featureType": "all",
                    "elementType": "geometry",
                    "stylers": [ { "color": "#96d454" } ]
                },
                {
                    "featureType": "water",
                    "elementType": "geometry.fill",
                    "stylers": [ { "saturation": "0" }, { "color": "#1297b1" }, { "visibility": "on" }, { "weight": "1" } ]
                },
                {
                    featureType: "road",
                    elementType: 'geometric',
                    stylers: [ { visibility: "on" }, { "color": "#7dc23d" } ]
                },
                {
                    "featureType": "transit",
                    "elementType": "all",
                    "stylers": [ { "visibility": "off" } ]
                },
                {
                    "featureType": "administrative",
                    "elementType": "all",
                    "stylers": [ { "visibility": "on" } ]
                },
                {
                    "featureType": "poi.park",
                    "elementType": "all",
                    "stylers": [ { "visibility": "on" } ]
                }
            ],

        });
        var infoWindow;

        addYourLocationButton(map);

        var pokemonIds = {};
        var markerClusterer = new MarkerClusterer(map, [], {
            imagePath: 'static/images/markercluster/m',
            minimumClusterSize: 4
        });

        function getRoute (origin, destination) {
            $.get('/api/routes', {origin: origin, destination: destination},
                    function (data) {

                        var _window = window.open('http://maps.google.com/maps?daddr=' + origin.latitude + ',' + origin.longitude +
                                '&saddr=' + destination.latitude + ',' + destination.longitude, '_blank');
                        _window.location;

                    }, "json")
                    .fail(function () {
                    })
                    .always(function () {

                    })
        }

        function getPokemons () {
            function buildMarker (pokemon) {
                var marker = new google.maps.Marker({
                    animation: google.maps.Animation.DROP,
                    position: new google.maps.LatLng(pokemon.position.lat, pokemon.position.long),
                    icon: {
                        url: pokemon.image_url,
                        size: new google.maps.Size(60, 60),
                        origin: new google.maps.Point(0, 0),
                        anchor: new google.maps.Point(32, 64)
                    },
                    expire_at: pokemon.expire_at,
                    map: map,
                });

                marker.addListener('click', function () {
                    if (infoWindow) {
                        infoWindow.close();

                        $("#map").off('click', '#take-me-there');
                    }
                    infoWindow = new google.maps.InfoWindow({
                        content: '<div id="info-window">' +
                        '  <div id=""></div>' +
                        '      <h1 id="firstHeading" class="">' + pokemon.name + '</h1>' +
                        '      <div id="bodyContent">' +
                        '         <p>Type: ' + pokemon.type + '</p>' +
                        '         <p>Weight: ' + pokemon.weight + '</p>' +
                        '         <p>Height: ' + pokemon.height + '</p>' +
                        '         <p>Disappears ' + moment.duration(pokemon.expire_at - new Date().getTime()).humanize(true) + '</p>' +
                        '         <button id="take-me-there">Take me there!</button>' +
                        '      </div>' +
                        '  </div>' +
                        '</div>'
                    });

                    $("#map").on('click', '#take-me-there', function () {
                        navigator.geolocation.getCurrentPosition(function (location) {
                            var origin = {
                                latitude: location.coords.latitude,
                                longitude: location.coords.longitude
                            };
                            var destination = {
                                latitude: pokemon.position.lat,
                                longitude: pokemon.position.long
                            };

                            /*getRoute(orgin, destination);*/

                            var parameters = '?saddr=' + origin.latitude + ',' + origin.longitude +
                                             '&daddr=' + destination.latitude + ',' + destination.longitude;

                            // http://stackoverflow.com/questions/4642481/android-launch-google-map-via-web-url
                            if (!isMobile()) {
                                var ref = window.open('http://maps.google.com/maps' + parameters, '_blank');
                                ref.focus();

                            } else {
                                if (isMobileiPhone()) {
                                    window.open('http://maps.apple.com/' + parameters, '_self');
                                    // open Google Maps app in iOS?
                                    // window.open('comgooglemaps://' + parameters, '_self');

                                } else if (isMobileAndroid()) {
                                    window.open('google.navigation:q=' + destination.latitude + ',' +
                                            destination.longitude + '&mode=d' , '_system');
                                } else {
                                    window.open('http://maps.google.com/maps' + parameters, '_self');
                                }

                            }
                        });
                    });

                    infoWindow.open(map, marker);
                });

                return marker;
            }

            function cleanExpiredPokemonMarkers () {
                var now = new Date().getTime();
                var markers = markerClusterer.getMarkers();
                for (var i = 0; i < markers.length; i++) {
                    if (markers[ i ].expire_at < now) {
                        if (markers[ i ].infowindow) {
                            markers[ i ].infowindow.close();
                        }

                        markerClusterer.removeMarker(markers[ i ]);

                        delete pokemonIds[ markers[ i ].id ];
                    }
                }
            }

            function addNewPokemonMarkers (pokemons) {
                for (var i = 0; i < pokemons.length; i++) {
                    if (!pokemons[i]) continue; // TODO: api sending pokemon as null
                    if (!pokemonIds[ pokemons[ i ].id ]) {
                        var marker = buildMarker(pokemons[ i ]);
                        markerClusterer.addMarker(marker);

                        pokemonIds[ pokemons[ i ].id ] = true;
                    }
                }
            }

            $.get('/api/pokemons', {},
                    function (data) {
                        cleanExpiredPokemonMarkers();

                        addNewPokemonMarkers(data);

                    }, "json")

                    .fail(function () {
                    })
                    .always(function () {
                        window.setTimeout(getPokemons, 10000);
                    });
        }

        getPokemons();
    });
</script>

<script>
    (function (i, s, o, g, r, a, m) {
        i[ 'GoogleAnalyticsObject' ] = r;
        i[ r ] = i[ r ] || function () {
                    (i[ r ].q = i[ r ].q || []).push(arguments)
                }, i[ r ].l = 1 * new Date();
        a = s.createElement(o),
                m = s.getElementsByTagName(o)[ 0 ];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-81195535-1', 'auto');
    ga('send', 'pageview');
</script>
</body>
</html>
